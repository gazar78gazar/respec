{
  "metadata": {
    "schema_version": "8.0",
    "model_type": "conformance_aware",
    "description": "UC Dataset Schema with batch conformance engine for manual uploads",
    "created_at": "2025-01-30",
    "updated_at": "2025-01-30",
    "dataset_version_compatible": "2.0+",
    "id_format": "coded_sequential",
    "naming_convention": "snake_case",
    "processing_mode": "batch",
    "major_changes_v3": [
      "Added comprehensive conformance engine for batch processing",
      "Implemented flagging system for validation issues",
      "Added sequential ID generation system",
      "Created manual upload processing pipeline",
      "Enhanced validation with recovery strategies",
      "Added conformance reporting framework"
    ]
  },

  "conformance_engine": {
    "description": "Batch processing engine for conforming manual uploads to UC dataset v2 format",
    "processing_pipeline": {
      "stages": [
        {
          "stage": 1,
          "name": "intake",
          "operations": ["file_validation", "format_detection", "initial_parsing"]
        },
        {
          "stage": 2,
          "name": "pre_processing",
          "operations": ["structure_analysis", "field_mapping", "type_detection"]
        },
        {
          "stage": 3,
          "name": "transformation",
          "operations": ["id_generation", "field_normalization", "reference_mapping"]
        },
        {
          "stage": 4,
          "name": "validation",
          "operations": ["schema_compliance", "reference_integrity", "business_rules"]
        },
        {
          "stage": 5,
          "name": "flagging",
          "operations": ["issue_detection", "severity_assignment", "review_queuing"]
        },
        {
          "stage": 6,
          "name": "conformance",
          "operations": ["final_transformation", "dataset_integration", "report_generation"]
        }
      ],
      "batch_configuration": {
        "max_batch_size": 1000,
        "processing_mode": "sequential",
        "transaction_support": true,
        "rollback_on_critical_error": true,
        "partial_success_allowed": false
      }
    },

    "manual_upload_handler": {
      "supported_formats": ["json", "csv", "xlsx", "yaml"],
      "upload_validation": {
        "max_file_size_mb": 50,
        "encoding_check": ["utf-8", "utf-16"],
        "structure_requirements": {
          "json": "valid JSON with array or object root",
          "csv": "header row required with consistent columns",
          "xlsx": "first sheet used, header in row 1",
          "yaml": "valid YAML with proper indentation"
        }
      },
      "parsing_rules": {
        "json": {
          "array_handling": "each element as separate node",
          "nested_objects": "flatten with path notation",
          "null_handling": "preserve as null"
        },
        "csv": {
          "delimiter_detection": ["comma", "semicolon", "tab"],
          "quote_handling": "standard CSV quoting",
          "empty_cell_handling": "convert to null"
        }
      }
    },

    "id_generation_system": {
      "strategy": "sequential_coded",
      "state_tracking": {
        "last_ids": {
          "scenario": "S13",
          "requirement": "R32",
          "specification": "P78",
          "comment": "C08",
          "exclusion": "E_SP_022"
        },
        "id_registry": "maintain in-memory during batch",
        "collision_check": "verify uniqueness before assignment"
      },
      "generation_rules": {
        "scenarios": {
          "pattern": "S[0-9]{2}",
          "next_available": "increment_from_last",
          "example": "S14, S15, S16..."
        },
        "requirements": {
          "pattern": "R[0-9]{2}",
          "next_available": "increment_from_last",
          "example": "R33, R34, R35..."
        },
        "specifications": {
          "pattern": "P[0-9]{2}",
          "next_available": "increment_from_last",
          "example": "P79, P80, P81..."
        },
        "comments": {
          "pattern": "C[0-9]{2}",
          "next_available": "increment_from_last",
          "example": "C09, C10, C11..."
        },
        "exclusions": {
          "pattern": "E_[A-Z]{2}_[0-9]{3}",
          "category_codes": {
            "PP": "spec_spec",
            "RR": "req_req",
            "SS": "scenario_scenario",
            "SP": "scenario_spec"
          },
          "next_available": "increment_within_category"
        }
      },
      "temporary_ids": {
        "prefix": "TEMP_",
        "usage": "during processing before final assignment",
        "cleanup": "replace with permanent IDs before conformance"
      }
    },

    "flagging_system": {
      "issue_categories": {
        "CRITICAL": {
          "description": "Blocks conformance, requires manual intervention",
          "examples": ["missing_required_field", "invalid_node_type", "circular_reference"],
          "action": "halt_batch_flag_for_review"
        },
        "ERROR": {
          "description": "Serious issue but can proceed with flags",
          "examples": ["orphaned_reference", "duplicate_name", "conflicting_exclusions"],
          "action": "flag_continue_with_warning"
        },
        "WARNING": {
          "description": "Potential issue, should be reviewed",
          "examples": ["unusual_value", "missing_optional_field", "deprecated_format"],
          "action": "flag_for_post_review"
        },
        "INFO": {
          "description": "Informational flag, no action required",
          "examples": ["auto_generated_id", "inferred_type", "default_applied"],
          "action": "log_in_report"
        }
      },
      "flag_structure": {
        "flag_id": "auto_generated_uuid",
        "timestamp": "iso_datetime",
        "batch_id": "batch_reference",
        "node_reference": "affected_node_id_or_path",
        "issue_type": "specific_validation_rule",
        "severity": "CRITICAL|ERROR|WARNING|INFO",
        "message": "human_readable_description",
        "suggestion": "recommended_action",
        "context": {
          "line_number": "for_file_uploads",
          "field_path": "json_path_notation",
          "actual_value": "problematic_value",
          "expected_value": "what_was_expected"
        }
      },
      "review_queue": {
        "priority_order": ["CRITICAL", "ERROR", "WARNING", "INFO"],
        "grouping": "by_issue_type_and_node",
        "bulk_actions": ["approve_all", "reject_all", "apply_suggestion"],
        "audit_trail": "track_all_review_decisions"
      }
    },

    "field_transformation_rules": {
      "naming_normalization": {
        "camelCase_to_snake_case": {
          "enabled": true,
          "examples": ["parentScenarios → parent_scenarios", "formField → form_field"]
        },
        "space_to_underscore": {
          "enabled": true,
          "examples": ["parent scenarios → parent_scenarios"]
        },
        "special_char_handling": {
          "enabled": true,
          "allowed": ["_"],
          "replace_with": "_"
        }
      },
      "type_inference": {
        "node_type_detection": {
          "by_id_pattern": {
            "S[0-9]+": "scenario",
            "R[0-9]+": "requirement",
            "P[0-9]+": "specification",
            "C[0-9]+": "comment",
            "E_*": "exclusion"
          },
          "by_field_presence": {
            "use_case_tags": "scenario",
            "form_field": "requirement",
            "form_mapping": "specification",
            "content": "comment"
          }
        }
      },
      "value_transformation": {
        "array_fields": {
          "string_to_array": "split by comma if string",
          "empty_to_array": "convert to empty array []",
          "single_to_array": "wrap single values in array"
        },
        "boolean_fields": {
          "string_to_bool": ["true/false", "yes/no", "1/0"],
          "empty_to_false": true
        },
        "null_handling": {
          "empty_string_to_null": true,
          "undefined_to_null": true,
          "preserve_explicit_null": true
        }
      }
    },

    "reference_mapping": {
      "id_resolution": {
        "temporary_to_permanent": "resolve after ID generation",
        "name_to_id": "lookup by name field if ID missing",
        "partial_match": "flag for review if ambiguous"
      },
      "bidirectional_sync": {
        "parent_child": "ensure both directions reference correctly",
        "exclusion_pairs": "verify both nodes reference exclusion",
        "requires_dependencies": "validate all required nodes exist"
      },
      "orphan_handling": {
        "detection": "identify nodes without valid parents",
        "resolution": {
          "specifications": "must have parent requirement",
          "requirements": "must have parent scenario",
          "comments": "must have at least one parent"
        },
        "action": "flag as ERROR for review"
      }
    }
  },

  "validation_framework": {
    "description": "Enhanced multi-layer validation with recovery strategies",
    
    "validation_layers": {
      "L1_schema_compliance": {
        "weight": 0.15,
        "checks": [
          "valid_id_format",
          "required_fields_present",
          "schema_version_compatible",
          "field_type_validation"
        ],
        "recovery_strategies": {
          "missing_id": "generate_sequential",
          "invalid_id_format": "flag_for_correction",
          "missing_required_field": "flag_as_critical",
          "wrong_field_type": "attempt_type_conversion"
        }
      },
      "L2_reference_integrity": {
        "weight": 0.10,
        "checks": [
          "all_parent_ids_exist",
          "no_orphaned_nodes",
          "bidirectional_refs_valid",
          "no_dangling_references"
        ],
        "recovery_strategies": {
          "missing_parent": "flag_as_error",
          "orphaned_node": "suggest_parent_assignment",
          "broken_bidirectional": "flag_for_sync",
          "dangling_reference": "remove_or_flag"
        }
      },
      "L3_exclusion_validation": {
        "weight": 0.20,
        "checks": [
          "exclusion_nodes_exist",
          "exclusion_categories_valid",
          "resolution_priority_assigned",
          "no_circular_exclusions",
          "no_self_exclusions"
        ],
        "recovery_strategies": {
          "missing_node": "flag_exclusion_invalid",
          "invalid_category": "infer_from_nodes",
          "missing_priority": "assign_default_3",
          "circular_exclusion": "flag_as_critical"
        }
      },
      "L4_form_mapping": {
        "weight": 0.15,
        "checks": [
          "field_name_exists_in_form",
          "selected_value_in_options",
          "ui_type_valid",
          "section_category_valid"
        ],
        "recovery_strategies": {
          "invalid_field_name": "suggest_closest_match",
          "value_not_in_options": "flag_for_review",
          "invalid_ui_type": "infer_from_options",
          "missing_section": "assign_default"
        }
      },
      "L5_hierarchy_enforcement": {
        "weight": 0.20,
        "checks": [
          "specs_have_parent_requirements",
          "requirements_have_parent_scenarios",
          "no_skip_level_relationships",
          "hierarchy_depth_valid"
        ],
        "recovery_strategies": {
          "missing_parent_level": "flag_as_error",
          "skip_level_found": "suggest_intermediate",
          "invalid_depth": "flag_for_restructure"
        }
      },
      "L6_dependency_validation": {
        "weight": 0.10,
        "checks": [
          "required_nodes_exist",
          "no_circular_dependencies",
          "dependency_categories_valid",
          "dependency_logic_valid"
        ],
        "recovery_strategies": {
          "missing_required": "flag_as_warning",
          "circular_dependency": "flag_as_critical",
          "invalid_category": "remove_category",
          "invalid_logic": "simplify_to_OR"
        }
      },
      "L7_coherence": {
        "weight": 0.10,
        "checks": [
          "coverage_complete",
          "no_contradictory_rules",
          "all_form_fields_covered",
          "naming_consistency"
        ],
        "recovery_strategies": {
          "incomplete_coverage": "identify_gaps",
          "contradictions": "flag_for_resolution",
          "missing_form_fields": "generate_stubs",
          "inconsistent_naming": "suggest_normalization"
        }
      }
    },

    "validation_scoring": {
      "calculation": "weighted_sum_of_layer_scores",
      "pass_threshold": 0.85,
      "critical_layers": ["L1", "L2", "L5"],
      "scoring_formula": "Σ(layer_weight * layer_score)",
      "layer_score": "passed_checks / total_checks",
      "batch_score": "average_of_all_node_scores"
    }
  },

  "conformance_reporting": {
    "report_structure": {
      "summary": {
        "batch_id": "unique_batch_identifier",
        "timestamp": "processing_timestamp",
        "input_file": "original_filename",
        "total_nodes": "count_by_type",
        "validation_score": "overall_score",
        "status": "SUCCESS|PARTIAL|FAILED",
        "critical_issues": "count",
        "errors": "count",
        "warnings": "count"
      },
      "detailed_issues": [
        {
          "node_id": "affected_node",
          "issue_type": "validation_rule",
          "severity": "level",
          "message": "description",
          "suggestion": "recommended_fix",
          "location": "line_or_path"
        }
      ],
      "id_assignments": [
        {
          "original_ref": "temp_id_or_name",
          "assigned_id": "new_sequential_id",
          "node_type": "type"
        }
      ],
      "transformation_log": [
        {
          "field": "field_name",
          "original": "original_value",
          "transformed": "new_value",
          "rule_applied": "transformation_rule"
        }
      ],
      "review_queue": [
        {
          "priority": "severity_level",
          "items": "list_of_flagged_issues",
          "suggested_actions": "bulk_actions_available"
        }
      ]
    },
    "export_formats": {
      "json": "full_structured_report",
      "html": "interactive_review_interface",
      "csv": "issue_list_for_spreadsheet",
      "markdown": "human_readable_summary"
    }
  },

  "batch_processing_workflow": {
    "step_1_upload": {
      "action": "receive_file",
      "validate": ["file_size", "format", "encoding"],
      "output": "parsed_raw_data"
    },
    "step_2_analyze": {
      "action": "analyze_structure",
      "detect": ["node_types", "relationships", "fields"],
      "output": "structured_nodes"
    },
    "step_3_generate_ids": {
      "action": "assign_sequential_ids",
      "maintain": "id_registry",
      "output": "nodes_with_ids"
    },
    "step_4_transform": {
      "action": "apply_transformation_rules",
      "normalize": ["field_names", "values", "references"],
      "output": "transformed_nodes"
    },
    "step_5_validate": {
      "action": "run_validation_layers",
      "calculate": "validation_scores",
      "output": "validation_results"
    },
    "step_6_flag": {
      "action": "generate_issue_flags",
      "categorize": "by_severity",
      "output": "flagged_issues"
    },
    "step_7_review": {
      "action": "present_for_review",
      "allow": ["approve", "reject", "modify"],
      "output": "review_decisions"
    },
    "step_8_conform": {
      "action": "apply_final_conformance",
      "merge": "into_dataset",
      "output": "conformed_data"
    },
    "step_9_report": {
      "action": "generate_reports",
      "include": ["summary", "issues", "changes"],
      "output": "conformance_report"
    }
  },

  "error_handling": {
    "critical_errors": {
      "handling": "stop_batch_processing",
      "examples": ["corrupt_file", "invalid_json", "schema_mismatch"],
      "recovery": "rollback_entire_batch"
    },
    "recoverable_errors": {
      "handling": "flag_and_continue",
      "examples": ["missing_optional", "format_issues", "reference_warnings"],
      "recovery": "apply_defaults_or_skip"
    },
    "transaction_support": {
      "enabled": true,
      "atomic_operations": "all_or_nothing_per_batch",
      "checkpoint_save": "after_each_stage",
      "rollback_capability": "to_last_checkpoint"
    }
  },

  "integration_specifications": {
    "dataset_merger": {
      "strategy": "append_with_deduplication",
      "conflict_resolution": "flag_duplicates",
      "id_uniqueness": "guaranteed_by_generation",
      "version_tracking": "maintain_change_log"
    },
    "api_endpoints": {
      "upload": "/api/conformance/upload",
      "status": "/api/conformance/batch/{id}/status",
      "report": "/api/conformance/batch/{id}/report",
      "review": "/api/conformance/batch/{id}/review",
      "approve": "/api/conformance/batch/{id}/approve",
      "export": "/api/conformance/batch/{id}/export"
    },
    "storage_requirements": {
      "temp_storage": "for_processing_batches",
      "audit_storage": "permanent_conformance_logs",
      "report_storage": "30_day_retention"
    }
  },

  "schema_structure": {
    "description": "Hierarchical graph model with many-to-many relationships and dependencies",
    "hierarchy": "scenarios >> requirements >> specifications",
    "relationship_types": ["parent_child", "exclusions", "requires"],
    "node_types": ["scenario", "requirement", "specification", "comment"],
    "id_patterns": {
      "scenario": "S[0-9]{2}",
      "requirement": "R[0-9]{2}",
      "specification": "P[0-9]{2}",
      "comment": "C[0-9]{2}",
      "exclusion": "E_[A-Z]{2}_[0-9]{3}"
    }
  },

  "node_definitions": {
    "scenario": {
      "required_fields": ["id", "type", "name", "description", "requirement_ids"],
      "optional_fields": ["use_case_tags", "conflicts_with", "compatible_scenarios", "metadata"],
      "id_pattern": "^S[0-9]{2}$",
      "parent_requirements": "none",
      "child_requirements": "must_have_requirements",
      "conformance_defaults": {
        "type": "scenario",
        "requirement_ids": [],
        "use_case_tags": []
      }
    },
    "requirement": {
      "required_fields": ["id", "type", "name", "description", "parent_scenarios", "specification_ids", "form_field"],
      "optional_fields": ["allows_conflicts", "category", "metadata"],
      "id_pattern": "^R[0-9]{2}$",
      "parent_requirements": "must_have_scenarios",
      "child_requirements": "must_have_specifications",
      "conformance_defaults": {
        "type": "requirement",
        "specification_ids": [],
        "allows_conflicts": false
      }
    },
    "specification": {
      "required_fields": ["id", "type", "name", "parent_requirements", "parent_scenarios", "form_mapping", "selected_value"],
      "optional_fields": ["requires", "description", "options", "selection_type", "technical_details"],
      "id_pattern": "^P[0-9]{2}$",
      "parent_requirements": "must_have_requirements",
      "child_requirements": "none",
      "conformance_defaults": {
        "type": "specification",
        "requires": null,
        "selection_type": "single_choice"
      }
    },
    "comment": {
      "required_fields": ["id", "type", "name", "parent_requirements", "parent_scenarios", "content"],
      "optional_fields": ["technical_context"],
      "id_pattern": "^C[0-9]{2}$",
      "parent_requirements": "must_have_parent",
      "child_requirements": "none",
      "conformance_defaults": {
        "type": "comment",
        "parent_requirements": [],
        "parent_scenarios": []
      }
    }
  },

  "dependency_structure": {
    "exclusions": {
      "description": "Pair-wise mutual exclusions between nodes",
      "structure": {
        "id": "string (E_XX_###)",
        "nodes": "array[2] of node IDs",
        "type": "enum[hard_incompatible, performance_mismatch, performance_warning, efficiency_warning]",
        "category": "enum[spec_spec, req_req, scenario_scenario, scenario_spec]",
        "reason": "string",
        "resolution_priority": "integer 1-4",
        "question_template": "string"
      },
      "conformance_rules": {
        "auto_category": "infer from node types if missing",
        "default_priority": 3,
        "default_type": "efficiency_warning"
      }
    },
    "requires": {
      "description": "Unidirectional dependencies where one node requires others",
      "structure": {
        "field_category": "array of required node IDs or null",
        "logic": "OR within category, AND across categories"
      },
      "conformance_rules": {
        "validate_references": "ensure all required nodes exist",
        "remove_invalid": "flag and remove non-existent references"
      }
    }
  },

  "implementation_notes": {
    "batch_processing_optimizations": [
      "Process in chunks of 100 nodes for memory efficiency",
      "Parallelize validation layers where possible",
      "Cache ID lookups for reference resolution",
      "Use streaming for large file uploads"
    ],
    "flagging_best_practices": [
      "Group similar issues for bulk resolution",
      "Provide clear, actionable suggestions",
      "Maintain context for each flag",
      "Enable batch approval for low-severity issues"
    ],
    "conformance_strategies": [
      "Validate early, transform late",
      "Preserve original data for audit trail",
      "Generate comprehensive reports for review",
      "Support incremental conformance for large datasets"
    ],
    "mvp_priorities": [
      "Focus on JSON and CSV upload formats initially",
      "Implement critical validation layers first",
      "Simple sequential ID generation",
      "Basic flagging without complex recovery",
      "Manual review interface for flagged issues"
    ]
  }
}