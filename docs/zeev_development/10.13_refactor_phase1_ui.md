# Refactor Summary: UI Extraction and Type‑Safe Hardening

## Why We Changed It
- Reduce complexity in a single monolithic `app.tsx` by separating UI and logic.
- Improve reusability and clarity through small, focused components with explicit props.
- Increase type safety (especially around dynamic indexing and MAS action payloads).
- Preserve UI parity and behavior while working side‑by‑side under `src/refactored/`.

## What Changed (High‑Level)
- Extracted repeated or complex UI into components under `src/refactored/components`.
- Introduced safe dynamic index maps:
  - `FIELD_DEFS` and `FIELD_GROUPS` (Record‑based views) to avoid TS7053 errors when indexing by `string`.
- Hardened `communicateWithMAS` with a generic, type‑safe signature using `refactored/types/mas.ts`.
- Removed commented code and stray JSX remnants in the refactored app.

## Results (Measured)

| File                     | Lines | `any` | `unknown` | `console.*` |
|--------------------------|------:|------:|----------:|------------:|
| `src/app.tsx`            |  2864 |    14 |       12  |          65 |
| `src/refactored/app.tsx` |  1838 |     5 |       18  |          62 |

Notes:
- ~36% fewer lines in the top‑level refactored app.
- Reduced `any`; `unknown` increased by design to force local narrowing.
- `console.*` slightly reduced (can be gated behind a logger later).

## Extracted Components (Role & Props)
- `HeaderBar` — Stage header with title and actions.
  - Props: `title`, `projectName?`, `onAutofillAll?`, `onExport?`, `onShare?`, `onConfigure?`, `disabled?`, `ids?`.
- `ActionButtons` — Reusable action button row.
  - Props: `onAutofillAll?`, `onExport?`, `onShare?`, `onConfigure?`, `disabled?`.
- `ProgressSummary` — Completion/accuracy bars + “key requirements left”.
  - Props: `completion`, `accuracy`, `missingFields`, `getFieldLabel(fieldKey)`, `onClickField(fieldKey)`, `className?`.
- `TabsNav` — Top area tabs for selecting sections.
  - Props: `tabs`, `active`, `onChange`, `className?`, `getLabel?`.
- `SectionAccordionGroup` — Collapsible group shell with counts and chevrons.
  - Props: `label`, `isExpanded`, `completedCount`, `totalCount`, `onToggle`, `children`.
- `FormField` — Single field UI (dropdown/multi/number/date/text) + assumption toggle + validation.
  - Props: `fieldKey`, `fieldDef`, `data?`, `section`, `required?`, `validation?`, `onChange(value, isAssumption)`.
- `RequirementsForm` — Renders sections → groups → fields.
  - Props: `sections`, `requirements`, `fieldDefs`, `groups`, `expandedGroups`, `onToggleGroup`, `onChangeField`, `isRequired`.
- `RequirementsReview` — Read‑only summary of completed fields per section.
  - Props: `requirements`, `getFieldLabel(section, fieldKey)`, `title?`.
- `ProcessingPopup` — Non‑blocking “Processing…” ribbon.
  - Props: `visible`, `message?`, `className?`.
- `ConflictPanelContainer` — Floating container for `ConflictPanel`.
  - Props: `visible`, `conflicts`, `onResolve`, `onDismiss?`, `className?`.
- `ConflictToggleButton` — Floating toggle for conflict visibility.
  - Props: `count`, `hasCritical?`, `onToggle`, `className?`.
- `MetricsLegend` — Standardized legend for Requirement vs Assumption.
  - Props: `className?`.

## Notable Technical Improvements
- Dynamic access safety: `FIELD_DEFS`/`FIELD_GROUPS` Record‑maps avoid union‑indexing errors and centralize shape assumptions.
- MAS bridge hardening: `communicateWithMAS<A extends MASAction>(action, data: PayloadMap[A])` enforces correct per‑action payloads; easier to evolve safely.
- TSX generic parse fix: Converted generic async arrow into a function declaration to remove TSX parsing ambiguity.
- Event handler typing: Avoids implicit `any` on browser events.

## Outcomes for the Team
- Faster UI changes: App is now an orchestrator; UI logic lives in small components.
- Lower refactor risk: Components are independently testable; props serve as contracts.
- Better DX: Fewer `any`, clearer dynamic lookups, stronger action payload typing.
- Maintainable: Reusable pieces (e.g., legend, popup, conflict wrappers) standardize the experience.

## Next Steps (Optional)
- Gate `console.*` behind a small logger (no‑op in prod) to satisfy stricter lint rules.
- Extract the “{activeTab} Specifications” row into `SpecsHeader` to complete presentational separation.
- Consolidate field validation into a dedicated module and pass results via `validation` prop to `FormField`.
- Gradually migrate other modules to use `FIELD_DEFS`/`FIELD_GROUPS` to eliminate residual dynamic index warnings.

